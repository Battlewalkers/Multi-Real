<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>My First Render Site</title>

  <style>
    :root { --card-bg: #ffffff; --accent: #4CAF50; --accent-hover: #45a049; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #6dd5fa, #2980b9);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      width: 100%;
      max-width: 700px;
      margin: 40px auto;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.18);
      box-sizing: border-box;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .top-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    button {
      background: var(--accent);
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background: var(--accent-hover);
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
      min-height: 1.2em;
    }

    label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 12px 0;
    }

    /* make the small test button not full width */
    #testButton {
      width: auto;
      padding: 8px 12px;
      font-size: 14px;
    }

    /* Responsive adjustments */
    @media (max-width: 520px) {
      .two-column { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: stretch; gap: 10px; }
      #testButton { justify-self: end; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Hello! Your site is working.</h1>
      <div class="top-controls">
        <!-- Test button placed at the side -->
        <button id="testButton">Send Test to Supabase</button>
      </div>
    </div>

    <div class="content">
      <h2>Age Check</h2>
      <label>
        <input type="checkbox" id="ageCheck">
        Are you 13 or older?
      </label>

      <div class="two-column">
        <!-- 13+ signup -->
        <div id="signupEmailSection" style="display:none;">
          <h3>Create Account (13+)</h3>
          <input id="signupEmail" type="email" placeholder="Email">
          <input id="signupPassword" type="password" placeholder="Password">
          <button id="signupButton">Sign Up</button>
        </div>

        <!-- Under 13 signup -->
        <div id="signupUsernameSection" style="display:none;">
          <h3>Create Account (Under 13)</h3>
          <input id="signupUsername" type="text" placeholder="Username">
          <button id="signupUserButton">Create Child Account</button>
        </div>
      </div>

      <h2>Login (13+)</h2>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPassword" type="password" placeholder="Password">
      <button id="loginButton">Log In</button>

      <p id="status"></p>
    </div>
  </div>

<script type="module">
  // --------------------------
  // CONFIG — replace these values with your project info
  // --------------------------
  // Put your project URL and anon key inside the quotes exactly.
  const SUPABASE_URL = "https://ytgwxpxjivruoewxbuyr.supabase.co"; // <-- replace
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0Z3d4cHhqaXZydW9ld3hidXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODMxODcsImV4cCI6MjA4MDA1OTE4N30.YMWdo_dRFKt5uufujOZ9BKe-Ygdc0fau1qVnltfmP6o";               // <-- replace
  // Where to send after successful login (change to your app page)
  const REDIRECT_AFTER_LOGIN = "/account-purpose.html"; // e.g. "/dashboard.html" or "/app.html"

  // --------------------------
  // Supabase client
  // --------------------------
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const supabase = createClient(https://ytgwxpxjivruoewxbuyr.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0Z3d4cHhqaXZydW9ld3hidXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODMxODcsImV4cCI6MjA4MDA1OTE4N30.YMWdo_dRFKt5uufujOZ9BKe-Ygdc0fau1qVnltfmP6o);

  // --------------------------
  // Element references (safe guards)
  // --------------------------
  const status = document.getElementById("status");
  const testButton = document.getElementById("testButton");
  const ageCheck = document.getElementById("ageCheck");
  const signupEmailSection = document.getElementById("signupEmailSection");
  const signupUsernameSection = document.getElementById("signupUsernameSection");
  const signupEmail = document.getElementById("signupEmail");
  const signupPassword = document.getElementById("signupPassword");
  const signupButton = document.getElementById("signupButton");
  const signupUsername = document.getElementById("signupUsername");
  const signupUserButton = document.getElementById("signupUserButton");
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginButton = document.getElementById("loginButton");

  function showStatus(msg) {
    if (status) status.innerText = msg;
    console.log(msg);
  }

  // --------------------------
  // Check for existing session on page load, redirect if signed in
  // --------------------------
  (async () => {
    try {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.warn("getSession error:", error);
        return;
      }
      if (data?.session) {
        console.log("User already signed in, redirecting...");
        window.location.href = REDIRECT_AFTER_LOGIN;
      }
    } catch (err) {
      console.error("Error checking session on load:", err);
    }
  })();

  // --------------------------
  // Test button: insert test message
  // --------------------------
  if (testButton) {
    testButton.addEventListener("click", async () => {
      try {
        const { error } = await supabase
          .from("test_messages")
          .insert([{ message: "Hello from my website!" }]);
        if (error) {
          showStatus("Test error: " + error.message);
          console.error("insert error:", error);
        } else {
          showStatus("Supabase works!");
          console.log("Test insert success");
        }
      } catch (err) {
        console.error("Unexpected test error:", err);
        showStatus("Test failed (see console).");
      }
    });
  }

  // --------------------------
  // Age toggle UI
  // --------------------------
  if (ageCheck) {
    ageCheck.addEventListener("change", () => {
      if (signupEmailSection && signupUsernameSection) {
        signupEmailSection.style.display = ageCheck.checked ? "block" : "none";
        signupUsernameSection.style.display = ageCheck.checked ? "none" : "block";
      }
    });
  }

  // --------------------------
  // Signup for 13+ (email + password)
  // --------------------------
  if (signupButton) {
    signupButton.addEventListener("click", async () => {
      const email = signupEmail?.value?.trim();
      const password = signupPassword?.value;
      if (!email || !password) {
        showStatus("Please enter email and password.");
        return;
      }
      try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        console.log("signUp result:", data, error);
        if (error) {
          showStatus(error.message);
        } else {
          showStatus("Check your email to confirm (if required).");
        }
      } catch (err) {
        console.error("Sign up failed:", err);
        showStatus("Sign up failed (see console).");
      }
    });
  }

  // --------------------------
  // Signup for under 13 (create child user row)
  // --------------------------
  if (signupUserButton) {
    signupUserButton.addEventListener("click", async () => {
      const username = signupUsername?.value?.trim();
      if (!username) {
        showStatus("Please enter a username.");
        return;
      }
      try {
        const { error } = await supabase
          .from("child_users")
          .insert([{ username }]);
        if (error) {
          showStatus(error.message);
          console.error("child_users insert error:", error);
        } else {
          window.location.href = "parent-confirm.html?child=" + encodeURIComponent(username);
        }
      } catch (err) {
        console.error("Create child account failed:", err);
        showStatus("Could not create child account (see console).");
      }
    });
  }

  // --------------------------
  // LOGIN: immediate redirect on successful sign-in
  // --------------------------
  if (loginButton) {
    loginButton.addEventListener("click", async () => {
      const email = loginEmail?.value?.trim();
      const password = loginPassword?.value;
      if (!email || !password) {
        showStatus("Please enter email and password.");
        return;
      }
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        console.log("signIn result:", data, error);
        if (error) {
          showStatus(error.message);
          return;
        }
        if (data?.session) {
          showStatus("Logged in! Redirecting…");
          window.location.href = REDIRECT_AFTER_LOGIN;
          return;
        }
        // No immediate session — often means email confirmation required
        showStatus("Signed in but no session found. Check email confirmation if required.");
      } catch (err) {
        console.error("Login error:", err);
        showStatus("Login failed (see console).");
      }
    });
  }
</script>

</body>
</html>
